!function n(o,u,d){function h(r,e){if(!u[r]){if(!o[r]){var i="function"==typeof require&&require;if(!e&&i)return i(r,!0);if(a)return a(r,!0);var t=new Error("Cannot find module '"+r+"'");throw t.code="MODULE_NOT_FOUND",t}var s=u[r]={exports:{}};o[r][0].call(s.exports,function(e){return h(o[r][1][e]||e)},s,s.exports,n,o,u,d)}return u[r].exports}for(var a="function"==typeof require&&require,e=0;e<d.length;e++)h(d[e]);return h}({1:[function(e,r,i){"use strict";var o,u,t,s;o=jQuery,u=Fizzmod,vtexjs.checkout,t=window,s={MDReviewsEntity:"RE",productId:null,reviewsCache:{},user:{},url:{GETPROFILE:"/no-cache/profileSystem/getProfile",LOGIN:"/login"},events:{READY:"Fizzmod.Reviews.Ready",REVIEWS_UPDATED:"Fizzmod.Reviews.Updated"},errors:{productIdNotDefined:"'productId' is not defined",reviewsNotDefined:"'reviews' is not defined",ratingNotDefined:"'rating' is not defined",ratingNotValid:"'rating' must be a number between 1 and 5",titleNotDefined:"'title' is not defined",userNotDefined:"'user' is not defined",userHasNoReview:"user has no active review",reviewUserIdNotDefined:"'reviewUserId' is not defined",reviewUserIdNotFound:"The 'reviewUserId' was not found in reviews"},init:function(e,r){var s=this;if(!e)return this._error("productIdNotDefined");this.productId=e;var i=[],t=this.getReviews();if(i.push(t),this._isValidUser(r))this.user=r;else{var n=o.get(this.url.GETPROFILE);i.push(n)}return o.when.apply(o,i).then(function(){for(var e=arguments.length,r=Array(e),i=0;i<e;i++)r[i]=arguments[i];if(2===r.length){var t=r[1][0];s._isValidUser(t)&&(s.user=t)}s._trigger(s.events.READY,[s.reviewsCache,s.user])}),this},_trigger:function(e,r){o(t).trigger(e,r)},_error:function(e,r){console.log(this.errors[e]),r&&console.log("Data:",r)},_isValidUser:function(e){return!!e&&!!e.IsUserDefined},_updateUserReview:function(e){var r=this;if(!e)return this._error("reviewsNotDefined");if(!this.isLoggedIn())return this._error("userNotDefined");if(!this.reviewsCache[this.user.UserId]){var i=this.reviewsCache[this.user.UserId]={helpfull:{yes:[],no:[]}},t=this.user.Email.match("@");t=null!=t?t[0].toString():this.user.Email,i.name=t,this.user.FirstName&&(i.name=this.user.FirstName),this.user.LastName&&(i.name+=" "+this.user.LastName)}o.extend(this.reviewsCache[this.user.UserId],e);var s=JSON.stringify(this.reviewsCache),n=u.MasterData.insertUpdate(this.productId,{reviews:s},this.MDReviewsEntity);return n.done(function(e){return r._trigger(r.events.REVIEWS_UPDATED,JSON.parse(e.getResults().reviews))}),n},login:function(){var r=this;if("undefined"!=typeof vtexid)vtexid.start(),o(document).on("click",".vtexIdUI-close",function(e){r.redirectOnLoginFail&&(document.referrer?t.location.href=document.referrer:t.location.href="/")});else{var e="/"+t.location.href.split("/").splice(3).join("/");t.location.href=this.url.LOGIN+"?ReturnUrl="+e}},isLoggedIn:function(){return!!this.user&&!!this.user.IsUserDefined},hasComments:function(){if(o.isEmptyObject(this.reviewsCache))return!1;var e=!0;for(var r in this.reviewsCache)if(this.reviewsCache[r].body&&this.reviewsCache[r].active){e=!1;break}return!e},getReviews:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.productId;if(!e)return this._error("productIdNotDefined");var r=u.MasterData.get(e,["reviews"],this.MDReviewsEntity);return r.done(function(e){var r=e.getResults(),i={};r&&r.reviews&&"string"==typeof r.reviews&&(i=JSON.parse(r.reviews)),t.reviewsCache=i,t._trigger(t.events.REVIEWS_UPDATED,i)}),r},publishRating:function(e){if(!this.isLoggedIn())return this.login();if(!e)return this._error("ratingNotDefined");if(o.isNumeric(e)||(e=parseInt(e,10)),5<e||e<1)return this._error("ratingNotValid");var r={rating:e};return this._updateUserReview(r)},publishTitle:function(e){if(!this.isLoggedIn())return this.login();if(!e)return this._error("titleNotDefined");var r={title:e};return this._updateUserReview(r)},publishBody:function(e){if(!this.isLoggedIn())return this.login();if(!e)return this._error("bodyNotDefined");var r={body:e};return this._updateUserReview(r)},submitReview:function(){if(!this.isLoggedIn())return this.login();var e=this.reviewsCache[this.user.UserId];if(!e)return this._error("userHasNoReview");if(!e.rating)return this._error("ratingNotDefined");if(!e.title)return this._error("titleNotDefined");if(!e.body)return this._error("bodyNotDefined");var r={active:!0,date:new Date};return this._updateUserReview(r)},voteHelpfullReview:function(e){if(!this.isLoggedIn())return this.login();if(!e)return this._error("reviewUserIdNotDefined");if(!this.reviewsCache[e])return this._error("reviewUserIdNotFound");var r=this.reviewsCache[e],i=r.helpfull;return-1==i.yes.indexOf(this.user.UserId)&&i.yes.push(this.user.UserId),-1!=i.no.indexOf(this.user.UserId)&&i.no.splice(i.no.indexOf(this.user.UserId),1),this._updateUserReview(r)},voteUnhelpfullReview:function(e){if(!this.isLoggedIn())return this.login();if(!e)return this._error("reviewUserIdNotDefined");if(!this.reviewsCache[e])return this._error("reviewUserIdNotFound");var r=this.reviewsCache[e],i=r.helpfull;return-1==i.no.indexOf(this.user.UserId)&&i.no.push(this.user.UserId),-1!=i.yes.indexOf(this.user.UserId)&&i.yes.splice(i.yes.indexOf(this.user.UserId),1),this._updateUserReview(r)}},u.Reviews=s},{}]},{},[1]);
//# sourceMappingURL=fizzmod.reviews.js.map
